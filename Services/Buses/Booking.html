<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booking - GoTrip</title>
  <link rel="stylesheet" href="../../HomePage/HomePageBuses.css" />
  <link rel="stylesheet" href="BusesSearchResults.css" />
  <style>
    .booking-container {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
    }
    
    .booking-card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }
    
    .booking-header {
      text-align: center;
      padding-bottom: 24px;
      border-bottom: 2px solid #e3e8f4;
      margin-bottom: 24px;
    }
    
    .booking-header h1 {
      margin: 0 0 8px 0;
      color: var(--ink);
    }
    
    .booking-header p {
      margin: 0;
      color: var(--muted);
    }
    
    .trip-summary {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 24px;
      align-items: center;
      padding: 24px;
      background: #f8f9fc;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .trip-point {
      text-align: left;
    }
    
    .trip-point:last-child {
      text-align: right;
    }
    
    .trip-point-time {
      font-size: 2rem;
      font-weight: 900;
      color: var(--ink);
    }
    
    .trip-point-city {
      font-size: 1.2rem;
      color: var(--muted);
      margin-top: 4px;
    }
    
    .trip-arrow {
      text-align: center;
      color: var(--muted);
    }
    
    .trip-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .info-item {
      padding: 16px;
      background: #f8f9fc;
      border-radius: 10px;
    }
    
    .info-label {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 6px;
    }
    
    .info-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--ink);
    }
    
    .features-list {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 24px 0;
    }
    
    .feature-tag {
      padding: 8px 14px;
      background: #e3f2fd;
      color: #007bff;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .total-price {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .total-label {
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .total-amount {
      font-size: 2rem;
      font-weight: 900;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    
    .btn-primary {
      padding: 14px 32px;
      border: none;
      border-radius: 10px;
      background: #28a745;
      color: white;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .btn-secondary {
      padding: 14px 32px;
      border: 2px solid #007bff;
      border-radius: 10px;
      background: white;
      color: #007bff;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-secondary:hover {
      background: #f4f7fc;
    }
    
    .loading-placeholder {
      text-align: center;
      padding: 60px 20px;
    }
    
    @media (max-width: 768px) {
      .trip-summary {
        grid-template-columns: 1fr;
        text-align: center;
      }
      
      .trip-point:last-child {
        text-align: center;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn-primary, .btn-secondary {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- ===== Header ===== -->
  <header class="site-header" role="banner">
    <div class="container nav">
      <a href="../../HomePage/HomePage.html" class="brand" aria-label="GoTrip Home">
        <span class="logo">
          <img src="../../HomePage/Photos/logo.jpg" alt="GoTrip Logo" class="logo-img" />
        </span>
        <span class="brand-name">GoTrip</span>
      </a>

      <nav class="primary-nav" aria-label="Primary">
        <a class="nav-link" href="../../HomePage/HomePage.html">Flights</a>
        <a class="nav-link" href="../../HomePage/HomePageHotels.html">Hotels</a>
        <a class="nav-link active" href="../../HomePage/HomePageBuses.html">Buses</a>
      </nav>

      <div class="actions">
        <a href="../../Login/signin.html" class="btn sign-in-btn">Sign in</a>
        <a href="../../Login/login.html" class="btn login-btn">Login</a>
      </div>
    </div>
  </header>

  <!-- ===== Booking Content ===== -->
  <div class="booking-container">
    <div id="loadingPlaceholder" class="loading-placeholder">
      <div class="spinner"></div>
      <p>Loading booking details...</p>
    </div>
    
    <div id="bookingContent" style="display: none;">
      <div class="booking-card">
        <div class="booking-header">
          <h1>Confirm Your Booking</h1>
          <p>Review your trip details before confirming</p>
        </div>
        
        <div class="trip-summary">
          <div class="trip-point">
            <div class="trip-point-time" id="departTime">--:--</div>
            <div class="trip-point-city" id="fromCity">---</div>
          </div>
          
          <div class="trip-arrow">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
              <path d="M5 12h14m-7-7l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <div id="duration" style="font-size: 0.9rem; margin-top: 8px;">-- h</div>
          </div>
          
          <div class="trip-point">
            <div class="trip-point-time" id="arriveTime">--:--</div>
            <div class="trip-point-city" id="toCity">---</div>
          </div>
        </div>
        
        <div class="trip-info-grid">
          <div class="info-item">
            <div class="info-label">Operator</div>
            <div class="info-value" id="operator">---</div>
          </div>
          <div class="info-item">
            <div class="info-label">Class</div>
            <div class="info-value" id="busClass">---</div>
          </div>
          <div class="info-item">
            <div class="info-label">Stops</div>
            <div class="info-value" id="stops">---</div>
          </div>
          <div class="info-item">
            <div class="info-label">Seats Available</div>
            <div class="info-value" id="seats">---</div>
          </div>
        </div>
        
        <div class="features-list" id="featuresList">
          <!-- Features will be populated here -->
        </div>
        
        <div class="total-price">
          <div class="total-label">Total Price</div>
          <div class="total-amount"><span id="totalPrice">0.00</span> <span id="currency">SAR</span></div>
        </div>
        
        <div class="action-buttons">
          <button class="btn-secondary" onclick="window.history.back()">Back to Results</button>
          <button class="btn-primary" onclick="confirmBooking()">Confirm Booking</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Footer ===== -->
  <footer class="site-footer">
    <div class="container footer-grid">
      <div class="footer-about">
        <h4>About GoTrip</h4>
        <p>Find, book, and explore the world with confidence.</p>
      </div>
      <div class="footer-links">
        <a href="#">About</a>
        <a href="#">Contact</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms</a>
      </div>
      <div class="footer-legal">© 2025 GoTrip. All rights reserved.</div>
    </div>
  </footer>

  <script>
    // Get trip ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const tripId = urlParams.get('trip');
    
    function formatTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
    }
    
    function formatDuration(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${hours}h ${mins > 0 ? mins + 'm' : ''}`.trim();
    }
    
    async function loadTripDetails() {
      try {
        // First try to get trip from localStorage (saved by search results page)
        let trip = null;
        const savedTrip = localStorage.getItem('selectedTrip');
        
        if (savedTrip) {
          trip = JSON.parse(savedTrip);
          console.log('Loaded trip from localStorage:', trip);
        } else {
          // Fallback: load from mock_buses.json
          const response = await fetch('mock_buses.json');
          const buses = await response.json();
          trip = buses.find(b => b.id === tripId);
        }
        
        if (!trip) {
          alert('Trip not found! Redirecting to search page...');
          window.location.href = 'BusesSearchResults.html';
          return;
        }
        
        // Populate trip details
        document.getElementById('departTime').textContent = formatTime(trip.departure);
        document.getElementById('arriveTime').textContent = formatTime(trip.arrival);
        document.getElementById('fromCity').textContent = trip.from;
        document.getElementById('toCity').textContent = trip.to;
        document.getElementById('duration').textContent = formatDuration(trip.duration || trip.duration_minutes || 90);
        document.getElementById('operator').textContent = trip.operator;
        document.getElementById('busClass').textContent = trip.class;
        document.getElementById('stops').textContent = trip.stops === 0 ? 'Nonstop' : `${trip.stops} stop${trip.stops > 1 ? 's' : ''}`;
        document.getElementById('seats').textContent = trip.seatsAvailable || trip.seats_left || 20;
        document.getElementById('totalPrice').textContent = (trip.price || 0).toFixed(2);
        document.getElementById('currency').textContent = trip.currency || 'SAR';
        
        // Populate features/amenities
        const featuresList = document.getElementById('featuresList');
        const features = trip.amenities || trip.features || [];
        featuresList.innerHTML = features.map(f => 
          `<span class="feature-tag">✓ ${f}</span>`
        ).join('');
        
        // Hide loading, show content
        document.getElementById('loadingPlaceholder').style.display = 'none';
        document.getElementById('bookingContent').style.display = 'block';
        
      } catch (error) {
        console.error('Error loading trip details:', error);
        alert('Failed to load trip details. Please try again.');
        window.location.href = 'BusesSearchResults.html';
      }
    }
    
    function confirmBooking() {
      alert('Booking confirmed! (Demo)\n\nIn production, this would:\n1. Process payment\n2. Send confirmation email\n3. Generate ticket\n4. Redirect to booking confirmation page');
      // In production: redirect to confirmation page
      // window.location.href = 'BookingConfirmation.html?booking=' + bookingId;
    }
    
    // Initialize
    if (!tripId) {
      alert('No trip selected!');
      window.location.href = 'BusesSearchResults.html';
    } else {
      loadTripDetails();
    }
  </script>
</body>
</html>
